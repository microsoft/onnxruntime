jobs:
- job: Android_CI
  
  pool:
    vmImage: 'macOS-10.15'
  timeoutInMinutes: 120

  steps:
    # Onnx has no 3.9 python package available yet, need to use python 3.8 to avoid build onnx package
    # pythonVersion can be updated in Azure pipeline settings
    # https://dev.azure.com/onnxruntime/onnxruntime/_build?definitionId=53
    - task: UsePythonVersion@0
      displayName: Use Python $(pythonVersion)
      inputs:
        versionSpec: $(pythonVersion)
    - script: brew install coreutils ninja
      displayName: Install coreutils and ninja
    - script: python3 tools/ci_build/build.py --android --build_dir build --android_sdk_path $ANDROID_HOME --android_ndk_path $ANDROID_HOME/ndk-bundle --android_abi=x86_64 --android_api=29 --skip_submodule_sync --parallel --cmake_generator=Ninja --build_java
      displayName: CPU EP, Build and Test on Android Emulator
    - script: /bin/bash tools/ci_build/github/android/run_nnapi_code_coverage.sh $(pwd)
      displayName: NNAPI EP, Build, Test and Get Code Coverage on Android Emulator
    - script: python -m pip install -q mysql-connector-python
      displayName: 'Install mysql-connector-python'

    - template: templates/set-version-number-variables-step.yml

    - task: PythonScript@0
      displayName: Post Code Coverage To Dash Board
      inputs:
        scriptPath: '$(Build.SourcesDirectory)/tools/ci_build/github/windows/post_code_coverage_to_dashboard.py'
        arguments: >
          --commit_hash=$(OnnxRuntimeGitCommitHash)
          --report_url="https://dev.azure.com/onnxruntime/onnxruntime/_build/results?buildId=$(Build.BuildId)"
          --report_file "build_nnapi/Debug/coverage_report.txt"
          --build_config '{\"os\": \"android\", \"arch\":\"x86_64\", \"config\":\"nnapi\"}'
        workingDirectory: $(pwd)
      env:
        DASHBOARD_MYSQL_ORT_PASSWORD: $(dashboard-mysql-ort-password)
    - script: /bin/bash tools/ci_build/github/linux/ort_minimal/nnapi_minimal_build_minimal_ort_and_run_tests.sh $(pwd)
      # Build Minimal ORT with NNAPI and reduced Ops, run unit tests on Android Emulator
      displayName: Build Minimal ORT with NNAPI and run tests
