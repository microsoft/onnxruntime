parameters:
- name: AdditionalBuildFlags
  displayName: Additional build flags for build.py
  type: string
  default: ''

# Must be 1 or 0
- name: AllowReleasedOpsetOnly
  displayName: Whether unreleased onnx opsets are allowed
  type: number
  default: 1
  values:
  - 1
  - 0

jobs:
- job: MacOS_C_API_Packaging_CPU_arm64
  workspace:
    clean: all
  variables:
    MACOSX_DEPLOYMENT_TARGET: '14.0'
    ALLOW_RELEASED_ONNX_OPSET_ONLY: ${{ parameters.AllowReleasedOpsetOnly }}
  pool:
   name: AcesShared
   os: macOS
   demands:
   - ImageOverride -equals ACES_VM_SharedPool_Sequoia
  timeoutInMinutes: 300
  steps:
  - checkout: self
    clean: true
    submodules: none

  - template: use-xcode-version.yml
    parameters:
      xcodeVersion: 16.4

  - template: setup-build-tools.yml
    parameters:
      host_cpu_arch: arm64

  - template: set-version-number-variables-step.yml

  - script: |
      set -e -x
      export ONNX_ML=1
      export CMAKE_ARGS="-DONNX_GEN_PB_TYPE_STUBS=ON -DONNX_WERROR=OFF"
      python3 -m pip install -r '$(Build.SourcesDirectory)/tools/ci_build/github/linux/docker/scripts/requirements.txt'    

  - template: mac-cpu-packaging-steps.yml
    parameters:
      MacosArch: arm64
      AdditionalBuildFlags: ${{ parameters.AdditionalBuildFlags }} --build_nodejs --use_coreml --use_webgpu --cmake_extra_defines CMAKE_OSX_ARCHITECTURES=arm64
