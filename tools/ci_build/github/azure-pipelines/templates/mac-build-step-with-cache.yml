# It's used for compilation with cache in Mac Host, not including iOS compilation.

parameters:
- name: TODAY
  type: string

- name: BuildStep
  type: stepList

- name: AdditionalKey
  type: string

- name: CCACHE_DIR
  type: string

steps:
  - script: |
      brew install ccache
      echo "##vso[task.prependpath]/usr/local/opt/ccache/libexec"
      mkdir -p "$(Pipeline.Workspace)/ccache"
    displayName: Install ccache and update PATH to use linked versions of gcc, cc, etc

  - task: Cache@2
    inputs:
      key:  ' "${{parameters.TODAY}}" | ${{parameters.AdditionalKey}} | "$(Build.SourceVersion)" '
      path: $(CCACHE_DIR)
      restoreKeys: |
        "${{parameters.TODAY}}" | ${{parameters.AdditionalKey}}
    displayName: ccache task
    env:
      CCACHE_DIR: ${{parameters.CCACHE_DIR}}

  - ${{ parameters.BuildStep }}

  - script: |
      set -ex
      ccache -s
      ccache -z
      ls -l $(Pipeline.Workspace)/ccache
      du -sh $(Pipeline.Workspace)/ccache
    displayName: Show Cache stats and Clear stats.
