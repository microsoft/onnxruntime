# component detection for component governance checks
parameters:
- name: condition
  type: string
  default: 'succeeded' # could be 'ci_only', 'always', 'succeeded'

steps:
- ${{ if eq(variables['System.TeamProject'], 'Lotus') }}:
  - powershell: |
      Remove-Item $(Build.BinariesDirectory)/* -Recurse -Force
    displayName: 'Clean up build directory'

  - task: ms.vss-governance-buildtask.governance-build-task-component-detection.ComponentGovernanceComponentDetection@0
    displayName: 'Component Detection'
    continueOnError: true
    condition:
      or(or(and(eq('${{parameters.condition}}', 'ci_only'), and(succeeded(), in(variables['Build.Reason'], 'IndividualCI', 'BatchedCI', 'Scheduled'))),
          and(eq('${{parameters.condition}}', 'always'), always())),
          and(eq('${{parameters.condition}}', 'succeeded'), succeeded()))
    inputs:
      # ignore unit tests in emscripten. emscripten unit tests are not used in onnxruntime build
      # ignore onnx third_party directory. onnx third_party directory is not responsible for onnxruntime build
      # ignore pybind11 third_party directory. pybind11 third_party directory is not responsible for onnxruntime build
      # ignore pybind11 tests directory. pybind11 tests directory is not responsible for onnxruntime build
      # ignore onnxruntime-extensions directory. onnxruntime-extensions directory is not responsible for onnxruntime build
      # ignore react_native e2e node_modules directory. react_native e2e node_modules directory is generated by react_native e2e tests
      # ignore js node_modules directory. js node_modules directory is generated by js tests
      # ignore onnxruntime-inference-examples directory. onnxruntime-inference-examples directory is used for inference examples, not for onnxruntime package
      # ignore BinariesDirectory. BinariesDirectory is used for build output, not for onnxruntime package
      ignoreDirectories:
        '$(Build.Repository.LocalPath)/cmake/external/emsdk/upstream/emscripten/tests,
        $(Build.Repository.LocalPath)/cmake/external/onnx/third_party/benchmark,
        $(Build.Repository.LocalPath)/cmake/external/onnx/third_party/pybind11,
        $(Build.Repository.LocalPath)/cmake/external/onnx/third_party/pybind11/tests,
        $(Build.Repository.LocalPath)/cmake/external/onnxruntime-extensions,
        $(Build.Repository.LocalPath)/js/react_native/e2e/node_modules,
        $(Build.Repository.LocalPath)/js/node_modules,
        $(Build.Repository.LocalPath)/onnxruntime-inference-examples,
        $(Build.SourcesDirectory)/cmake/external/emsdk/upstream/emscripten/tests,
        $(Build.SourcesDirectory)/cmake/external/onnx/third_party/benchmark,
        $(Build.SourcesDirectory)/cmake/external/onnx/third_party/pybind11,
        $(Build.SourcesDirectory)/cmake/external/onnx/third_party/pybind11/tests,
        $(Build.SourcesDirectory)/cmake/external/onnxruntime-extensions,
        $(Build.SourcesDirectory)/js/react_native/e2e/node_modules,
        $(Build.SourcesDirectory)/js/node_modules,
        $(Build.SourcesDirectory)/onnxruntime-inference-examples,
        $(Build.BinariesDirectory)'