# sets up common build tools for the windows build machines before build

parameters:
  EnvSetupScript: ''
  buildArch: amd64
  setVcvars: false
steps:
    - task: NuGetToolInstaller@0
      displayName: Use Nuget 4.9
      inputs:
        versionSpec: 4.9.4
    - task: NuGetCommand@2
      displayName: 'NuGet restore'
      inputs:
        restoreSolution: '$(Build.SourcesDirectory)\csharp\OnnxRuntime.CSharp.sln'
        feedsToUse: config
        nugetConfigPath: '$(Build.SourcesDirectory)\csharp\Nuget.CSharp.config'
        restoreDirectory: '$(Build.SourcesDirectory)\csharp'
    # - task: UniversalPackages@0
    #   displayName: 'Download python'
    #   inputs:
    #     command: download
    #     vstsFeed: '$(System.TeamProject)'
    #     vstsFeedPackage: 'miniconda3_win64'
    #     vstsPackageVersion: '4.5.11'
    #     downloadDirectory: '$(Build.BinariesDirectory)\python'

    # Temporary bypass of artifacts permission issue
    - task: PowerShell@2
      displayName: 'Download python'
      inputs:
        targetType: 'inline'
        script: 'Invoke-WebRequest --MaximumRetryCount 10 -OutFile installer.exe  https://onnxruntimeinstaller.blob.core.windows.net/conda-installer/installer.exe'
        workingDirectory: '$(Build.BinariesDirectory)'

    - task: PowerShell@2
      displayName: 'Download azcopy'
      inputs:
        targetType: 'inline'
        script: 'Invoke-WebRequest --MaximumRetryCount 10 -OutFile azcopy.zip  https://aka.ms/downloadazcopy-v10-windows'
        workingDirectory: '$(Build.BinariesDirectory)'

    - task: ExtractFiles@1
      inputs:
        archiveFilePatterns: '$(Build.BinariesDirectory)\azcopy.zip'
        destinationFolder: $(Build.BinariesDirectory)\azcopy

    - task: CmdLine@1
      displayName: 'Run python installer'
      inputs:
        filename: '$(Build.BinariesDirectory)\installer.exe'
        arguments: '/S /NoRegistry=1 /AddToPath=0 /RegisterPython=0 /D=$(Build.BinariesDirectory)\packages\python'
      timeoutInMinutes: 10
    - task: BatchScript@1
      displayName: 'setup env'
      inputs:
        filename: '$(Build.SourcesDirectory)\tools\ci_build\github\windows\${{parameters.EnvSetupScript}}'
        modifyEnvironment: true
        workingFolder: '$(Build.BinariesDirectory)'
    - task: CmdLine@1
      displayName: 'Install conda modules'
      inputs:
        filename: '$(Build.BinariesDirectory)\packages\python\scripts\conda.exe'
        arguments: 'install -q --insecure -y pyopenssl setuptools wheel numpy'
      timeoutInMinutes: 10

    - task: CmdLine@1
      displayName: 'Download cmake'
      inputs:
        filename: '$(Build.BinariesDirectory)\packages\python\python.exe'
        arguments: '$(Build.SourcesDirectory)\tools\ci_build\github\windows\download_cmake.py --build_dir $(Build.BinariesDirectory)'
    
    - task: PowerShell@2
      displayName: 'Download OpenCppCoverage installer'
      continueOnError: true
      inputs:
        targetType: 'inline'
        script: '
          New-Item -Path "$(Build.BinariesDirectory)\installer" -ItemType "directory"

          New-Item -Path "$(Build.BinariesDirectory)\installer\opencppcoverage" -ItemType "directory"

          Invoke-WebRequest -OutFile $(Build.BinariesDirectory)\installer\opencppcoverage\installer.exe https://onnxruntimeinstaller.blob.core.windows.net/opencppcovergae-installer/OpenCppCoverageSetup-x64-0.9.7.0.exe
          '

    - task: CmdLine@1
      continueOnError: true
      displayName: 'Run OpenCPPCoverage installer'
      inputs:
        filename: '$(Build.BinariesDirectory)\installer\opencppcoverage\installer.exe'
        arguments: '/SP- /VERYSILENT /SUPPRESSMSGBOXES /NORESTART /DIR="$(Build.BinariesDirectory)\OpenCppCoverage"'

    - task: BatchScript@1
      displayName: 'Setup VS2017 env vars'
      inputs:
        filename: 'C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvarsall.bat'
        arguments: '${{parameters.buildArch}} -vcvars_ver=14.11'
        modifyEnvironment: true
      condition: ${{parameters.setVcvars}}
