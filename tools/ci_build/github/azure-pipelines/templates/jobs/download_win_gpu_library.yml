parameters:
  - name: DownloadCUDA
    type: boolean
    default: false
  - name: DownloadTRT
    type: boolean
    default: false
  - name: CudaVersion
    type: string
    default: '12.8'
    values:
      - 13.0
      - 12.8

variables:
- template: ../templates/common-variables.yml
- name: TrtFolder
  ${{ if eq(parameters.CudaVersion, '13.0') }}:
    value: ${{ variables.win_trt_folder_cuda13 }}
  ${{ if eq(parameters.CudaVersion, '12.8') }}:
    value: ${{ variables.win_trt_folder_cuda12 }}

steps:
  - ${{ if eq(parameters.DownloadCUDA, true) }}:
    - task: AzureCLI@2
      displayName: 'Download CUDA SDK v${{ parameters.CudaVersion }}'
      inputs:
        azureSubscription: AIInfraBuildOnnxRuntimeOSS
        scriptType: 'batch'
        scriptLocation: 'inlineScript'
        inlineScript: |
          set AZCOPY_AUTO_LOGIN_TYPE=AZCLI
          azcopy.exe cp --recursive https://lotusscus.blob.core.windows.net/models/cuda_sdk/v${{ parameters.CudaVersion }} $(Agent.TempDirectory)

    - powershell: |
        Write-Host "##vso[task.prependpath]$(Agent.TempDirectory)\v${{ parameters.CudaVersion }}\bin;$(Agent.TempDirectory)\v${{ parameters.CudaVersion }}\extras\CUPTI\lib64"
      displayName: 'Append CUDA SDK Directory to PATH'

    - task: CmdLine@2
      inputs:
        script: |
          echo %PATH%
          dir $(Agent.TempDirectory)
      displayName: 'Print PATH after download CUDA SDK'

    - task: AzureCLI@2
      displayName: 'Download ${{ variables.TrtFolder }}'
      inputs:
        azureSubscription: AIInfraBuildOnnxRuntimeOSS
        scriptType: 'batch'
        scriptLocation: 'inlineScript'
        inlineScript: |
          set AZCOPY_AUTO_LOGIN_TYPE=AZCLI
          azcopy.exe cp --recursive https://lotusscus.blob.core.windows.net/models/local/${{ variables.TrtFolder }} $(Agent.TempDirectory)

    - powershell: |
        Write-Host "##vso[task.prependpath]$(Agent.TempDirectory)\${{ variables.TrtFolder }}\lib"
      displayName: 'Append ${{ variables.TrtFolder }} Directory to PATH'

    - task: CmdLine@2
      inputs:
        script: |
          echo %PATH%
      displayName: 'Print PATH after download TensorRT'
