parameters:
  - name: DownloadCUDA
    type: boolean
    default: false
  - name: DownloadTRT
    type: boolean
    default: false
  - name: CudaVersion
    type: string
    default: '12.8'
    values:
      - 13.0
      - 12.8
  - name: TrtVersion
    type: string
    default: '10.9.0.34'
    values:
      - 10.9.0.34
      - 10.13.3.9

steps:
  - ${{ if eq(parameters.DownloadCUDA, true) }}:
    - task: AzureCLI@2
      displayName: 'Download CUDA SDK v${{ parameters.CudaVersion }}'
      inputs:
        azureSubscription: AIInfraBuildOnnxRuntimeOSS
        scriptType: 'batch'
        scriptLocation: 'inlineScript'
        inlineScript: |
          set AZCOPY_AUTO_LOGIN_TYPE=AZCLI
          azcopy.exe cp --recursive https://lotusscus.blob.core.windows.net/models/cuda_sdk/v${{ parameters.CudaVersion }} $(Agent.TempDirectory)

    - powershell: |
        Write-Host "##vso[task.prependpath]$(Agent.TempDirectory)\v${{ parameters.CudaVersion }}\bin;$(Agent.TempDirectory)\v${{ parameters.CudaVersion }}\extras\CUPTI\lib64"
      displayName: 'Append CUDA SDK Directory to PATH'

    - task: CmdLine@2
      inputs:
        script: |
          echo %PATH%
          dir $(Agent.TempDirectory)
      displayName: 'Print PATH after download CUDA SDK'

  - ${{ if eq(parameters.DownloadTRT, true) }}:
    - ${{ if eq(parameters.CudaVersion, '13.0') }}:
        - powershell: |
            Write-Host "##vso[task.setvariable variable=trtCudaVersion;]13.0"
          displayName: Set trtCudaVersion
    - ${{ if and(eq(parameters.CudaVersion, '12.8'), eq(parameters.TrtVersion, '10.13.3.9')) }}:
        - powershell: |
            Write-Host "##vso[task.setvariable variable=trtCudaVersion;]12.9"
          displayName: Set trtCudaVersion
    - ${{ if and(eq(parameters.CudaVersion, '12.8'), eq(parameters.TrtVersion, '10.9.0.34')) }}:
        - powershell: |
            Write-Host "##vso[task.setvariable variable=trtCudaVersion;]12.8"
          displayName: Set trtCudaVersion

    - ${{ if eq(parameters.TrtVersion, '10.9.0.34') }}:
      - powershell: |
          Write-Host "##vso[task.setvariable variable=trtPlatformString;]Windows10.x86_64"
        displayName: 'Set TRT platform string for 10.9.0.34'

    - ${{ if eq(parameters.TrtVersion, '10.13.3.9') }}:
      - powershell: |
          Write-Host "##vso[task.setvariable variable=trtPlatformString;]Windows.win10"
        displayName: 'Set TRT platform string for 10.13.3.9'

    - powershell: |
        $trtDirName = "TensorRT-${{ parameters.TrtVersion }}.$(trtPlatformString).cuda-$(trtCudaVersion)"
        Write-Host "TensorRT Directory Name: $trtDirName"
        Write-Host "##vso[task.setvariable variable=trtDirName;]$trtDirName"
      displayName: 'Construct TensorRT Directory Name'

    - task: AzureCLI@2
      displayName: 'Download $(trtDirName)'
      inputs:
        azureSubscription: AIInfraBuildOnnxRuntimeOSS
        scriptType: 'batch'
        scriptLocation: 'inlineScript'
        inlineScript: |
          set AZCOPY_AUTO_LOGIN_TYPE=AZCLI
          azcopy.exe cp --recursive https://lotusscus.blob.core.windows.net/models/local/$(trtDirName) $(Agent.TempDirectory)

    - powershell: |
        Write-Host "##vso[task.prependpath]$(Agent.TempDirectory)\$(trtDirName)\lib"
      displayName: 'Append $(trtDirName) Directory to PATH'

    - task: CmdLine@2
      inputs:
        script: |
          echo %PATH%
      displayName: 'Print PATH after download TensorRT'
