# This stage fetch built macOS binaries from other stages, sign the binaries, then repack them

parameters:
- name: AdditionalBuildFlags
  displayName: Additional build flags for build.py
  type: string
  default: ''

# Must be 1 or 0
- name: AllowReleasedOpsetOnly
  displayName: Whether unreleased onnx opsets are allowed
  type: number
  default: 1
  values:
  - 1
  - 0

- name: DoESRP
  displayName: Do ESRP
  type: boolean
  default: false

stages:
- stage: MacOS_C_API_Packaging_CPU
  dependsOn: []
  jobs:
  - template: mac-cpu-packing-jobs.yml
    parameters:
      MacosArch: 'x86_64'
      AllowReleasedOpsetOnly: ${{ parameters.AllowReleasedOpsetOnly }}
      AdditionalBuildFlags: ${{ parameters.AdditionalBuildFlags }}

  - template: mac-cpu-packing-jobs.yml
    parameters:
      MacosArch: 'arm64'
      AllowReleasedOpsetOnly: ${{ parameters.AllowReleasedOpsetOnly }}
      AdditionalBuildFlags: ${{ parameters.AdditionalBuildFlags }}

- stage: MacOS_C_API_Package_Publish
  dependsOn: MacOS_C_API_Packaging_CPU
  jobs:
  - job: MacOS_C_API_Package_Publish
    pool:
      name: 'Azure Pipelines'
      image: 'macOS-14'
      os: 'macOS'
    templateContext:
      inputs:
      - input: pipelineArtifact
        artifactName: onnxruntime-osx-x86_64 # The files in this artifact are not signed
        targetPath: $(Build.ArtifactStagingDirectory)
      - input: pipelineArtifact
        artifactName: onnxruntime-osx-arm64 # The files in this artifact are not signed
        targetPath: $(Build.ArtifactStagingDirectory)
      outputs:
      - output: pipelineArtifact
        targetPath: $(Build.ArtifactStagingDirectory)
        artifactName: 'onnxruntime-osx' # The files in this artifact are signed
    steps:
    - checkout: self

    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.13'
        addToPath: true

    - task: PythonScript@0
      displayName: 'Prepare, Create Universal Binary, and Zip with Python'
      inputs:
        scriptSource: 'filePath'
        scriptPath: 'tools/ci_build/prepare_macos_package.py'
        arguments: '--staging_dir $(Build.ArtifactStagingDirectory)'

    - template: mac-esrp-dylib.yml
      parameters:
        FolderPath: '$(Build.ArtifactStagingDirectory)'
        Pattern: '*.zip'

    - script: |
        set -ex
        mkdir temp
        cd temp
        find $(Build.ArtifactStagingDirectory) -name '*.zip' -exec unzip {} \;
        rm -rf $(Build.ArtifactStagingDirectory)/*;
        find . -type d -name 'onnxruntime-osx-*' -exec tar -czf {}.tgz {} \;        
        ls -l
        mv *.tgz $(Build.ArtifactStagingDirectory)
      displayName: 'Unzip Signed Files and Repackage to TGZ'
      workingDirectory: $(Agent.TempDirectory)

    - bash: |
        set -ex
        mkdir -p macpackage
        find $(Build.ArtifactStagingDirectory) -name "*.tgz" -exec tar -zxvf {} -C macpackage \;
        find macpackage -name "*.dylib" -exec codesign -dvvv {} \;
        find macpackage -name "*.dylib" -exec ls -l {} \;
        rm -rf macpackage
      displayName: 'Verify Code Signing'
      workingDirectory: $(Agent.TempDirectory)
