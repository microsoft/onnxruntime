parameters:
- name: NpmPackagingMode
  displayName: 'NPM packages publish configuration'
  type: string
  default: 'dev'
- name: BuildConfig
  displayName: 'Build config'
  type: string
  values:
  - 'Release'
  - 'MinSizeRel'
  - 'Debug'
  - 'RelWithDebugInfo'
  default: 'Release'
- name: PoolName
  displayName: 'Pool name'
  type: string
- name: PackageName
  displayName: 'Package name'
  type: string
  default: 'NPM_packages'
- name: InitialStageDependsOn
  displayName: 'Stage that the initial stage of react-native-ci depends on'
  type: string
  default: ''
- name: enable_code_sign
  displayName: Use GPG to sign the jars
  type: boolean

stages:
- stage: Build_Android_Packages
  displayName: Build_Android_Packages
  dependsOn: '${{parameters.InitialStageDependsOn}}'
  jobs:
  - template: android-java-api-aar.yml
    parameters:
      buildConfig: '${{parameters.BuildConfig}}'
      buildSettings: '$(Build.SourcesDirectory)/tools/ci_build/github/js/react_native_e2e_full_aar_build_settings.json'
      artifactName: 'onnxruntime-android-full-aar'
      job_name_suffix: 'For_React_Native'
      enable_code_sign: '${{parameters.enable_code_sign}}'
      pool_name: '${{parameters.PoolName}}'
      packageName: 'onnxruntime-android'
      is1ES: true

- stage: ReactNative_CI_Android
  displayName: ReactNative_CI_Android
  dependsOn: Build_Android_Packages
  jobs:
  - template: ../stages/jobs/react-natvie-andriod-e2e-test-job.yml
    parameters:
      PackageName: '${{parameters.PackageName}}'
      ArtifactName: 'onnxruntime-android-full-aar'
      NpmPackagingMode: '${{parameters.NpmPackagingMode}}'

- stage: ReactNative_CI_iOS
  displayName: ReactNative_CI_iOS
  dependsOn: '${{parameters.InitialStageDependsOn}}'
  jobs:
  - job: ReactNative_CI_iOS_build
    pool:
      name: AcesShared
      os: macOS
      demands:
      - ImageOverride -equals ACES_VM_SharedPool_Sequoia
    timeoutInMinutes: 120
    variables:
      runCodesignValidationInjection: false
    steps:
    - template: use-xcode-version.yml
      parameters:
        xcodeVersion: 16.4

    - template: setup-build-tools.yml
      parameters:
        host_cpu_arch: arm64
        python_version: '3.12'

    - script: |
        pip install -r tools/ci_build/github/apple/ios_packaging/requirements.txt
      displayName: "Install Python requirements"

    # Build the iOS package
    - script: |
        set -e -x
        python $(Build.SourcesDirectory)/tools/ci_build/github/apple/build_and_assemble_apple_pods.py \
          --build-dir "$(Build.BinariesDirectory)/ios_framework_full" \
          --staging-dir "$(Build.BinariesDirectory)/ios_pod" \
          --build-settings-file $(Build.SourcesDirectory)/tools/ci_build/github/js/react_native_e2e_full_ios_framework_build_settings_arm64.json
      displayName: Build iOS package and assemble pods

    - task: 1ES.PublishPipelineArtifact@1
      inputs:
        artifactName: 'ios_pod'
        targetPath: '$(Build.BinariesDirectory)/ios_pod'
      displayName: Publish React Native iOS pod files

  - job: ReactNative_CI_iOS_unit_tests
    dependsOn: 'ReactNative_CI_iOS_build'
    pool:
      name: AcesShared
      os: macOS
      demands:
      - ImageOverride -equals ACES_VM_SharedPool_Sequoia
    timeoutInMinutes: 90

    steps:
    - template: flex-downloadPipelineArtifact.yml
      parameters:
        StepName: 'Download Pipeline Artifact - ios_pod'
        ArtifactName: 'ios_pod'
        TargetPath: '$(Build.BinariesDirectory)/ios_pod'

    - template: use-xcode-version.yml
      parameters:
        xcodeVersion: 16.4

    - task: NodeTool@0
      inputs:
        versionSpec: '22.x'

    - template: ../stages/jobs/steps/react-native-bootstrap-steps.yml

    - script: |
        brew tap wix/brew
        brew install applesimutils
      displayName: Install applesimutils

    - script: |
        gem install securerandom -v 0.3.2 --user-install --force
        gem install drb -v 2.0.6 --user-install --force
        gem install zeitwerk -v 2.6.18 --user-install --force
        gem install activesupport -v 6.0.6.1 --user-install --force
        gem install ffi -v 1.15.5 --user-install --force
        gem install cocoapods -v 1.11.3 --user-install --force
      displayName: Install CocoaPods

    - script: |
        set -e -x
        export PATH=$HOME/.gem/ruby/2.6.0/bin:$PATH
        export LANG=en_US.UTF-8
        ORT_C_LOCAL_POD_PATH=$(Build.BinariesDirectory)/ios_pod/onnxruntime-c pod install --verbose
      workingDirectory: '$(Build.SourcesDirectory)/js/react_native/e2e/ios'
      displayName: Pod install for onnxruntime react native ios bridge library

    - script: |
        xcrun simctl list runtimes
        xcrun simctl list devices
        detox build --configuration ios.sim_18_6.release
        JEST_JUNIT_OUTPUT_FILE=$(Build.SourcesDirectory)/js/react_native/e2e/ios-test-results.xml \
        detox test --record-logs all \
                    --configuration ios.sim_18_6.release \
                    --loglevel verbose \
                    --take-screenshots failing
      workingDirectory: '$(Build.SourcesDirectory)/js/react_native/e2e'
      displayName: Build and Run Detox iOS e2e Tests

    - task: PublishTestResults@2
      inputs:
        testResultsFiles: '$(Build.SourcesDirectory)/js/react_native/e2e/ios-test-results.xml'
        failTaskOnFailedTests: true
        testRunTitle: 'React Native iOS Instrumented Test results'
      condition: succeededOrFailed()
      displayName: Publish React Native iOS Instrumented Test Results

    - template: explicitly-defined-final-tasks.yml
