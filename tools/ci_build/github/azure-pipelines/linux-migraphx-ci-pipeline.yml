trigger: none

name: 'linux_ci_$(Date:yyyyMMdd)_$(Rev:r)'
jobs:
- job: AMDMIGraphX_CI
  pool: 'AMD-GPU'
  timeoutInMinutes: 60

  # gid of video and render group on gcr-openpai-35 and -36
  variables:
    - name: video
      value: 44
    - name: render
      value: 109
    - name: RocmVersion
      value: 5.2.3

  steps:
  - checkout: self
    clean: true

  - template: get-docker-image-steps.yml
    parameters:
      Dockerfile: tools/ci_build/github/pai/migraphx-ci-pipeline-env.Dockerfile
      Context: tools/ci_build/github/pai
      Repository: onnxruntimetrainingrocm-cibuild-rocm$(RocmVersion)

  - task: CmdLine@2
    inputs:
      script: |-
      docker run --rm \
        -e HIP_VISIBLE_DEVICES \
        --privileged \
        --security-opt seccomp=unconfined \
        --shm-size=1024m \
        --device=/dev/kfd \
        --device=/dev/dri \
        --group-add $(video) \
        --group-add $(render) \
        --volume $(Build.SourcesDirectory):/onnxruntime_src \
        --volume $(Build.BinariesDirectory):/build \
        --workdir /onnxruntime_src \
        --user onnxruntimedev \
        onnxruntimetrainingrocm-cibuild-rocm$(RocmVersion) \
          python tools/ci_build/build.py \
            --config RelWithDebInfo \
            --mpi_home /opt/ompi \
            --use_migraphx \
            --rocm_version=5.2.3 \
            --rocm_home /opt/rocm \
            --nccl_home /opt/rocm \
            --update \
            --build_dir ./build \
            --build \
            --parallel 8 \
            --build_wheel \
            --skip_tests
    displayName: 'Build onnxruntime'

  - task: CmdLine@2
    inputs:
      script: |-
      docker run --rm \
        -e HIP_VISIBLE_DEVICES \
        --privileged \
        --security-opt seccomp=unconfined \
        --shm-size=1024m \
        --device=/dev/kfd \
        --device=/dev/dri \
        --group-add $(video) \
        --group-add $(render) \
        --volume $(Build.SourcesDirectory):/onnxruntime_src \
        --volume $(Build.BinariesDirectory):/build \
        --workdir /onnxruntime_src \
        --user onnxruntimedev \
        onnxruntimetrainingrocm-cibuild-rocm$(RocmVersion) \
          /tools/ci_build/github/pai/migraphx_test_launcher.sh ./build/RelWithDebInfo
    displayName: 'Run onnxruntime unit tests'
