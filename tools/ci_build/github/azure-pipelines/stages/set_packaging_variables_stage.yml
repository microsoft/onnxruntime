parameters:
  IsReleaseBuild: false
  PreReleaseVersionSuffixString: 'none'
  PreReleaseVersionSuffixNumber: 0
stages:
- stage: Setup
  jobs:
  - job: Set_Variables
    pool:
      name: 'onnxruntime-Ubuntu2204-AMD-CPU'
      os: linux
    steps:
    - checkout: none
    - task: Bash@3
      displayName: "Set Release Version Suffix"
      env:
        IS_RELEASE_BUILD: ${{ parameters.IsReleaseBuild }}
        PRE_RELEASE_SUFFIX_STRING: ${{ parameters.PreReleaseVersionSuffixString }}
        PRE_RELEASE_SUFFIX_NUMBER: ${{ parameters.PreReleaseVersionSuffixNumber }}
      script: |
        set +x
        if [[ "$IS_RELEASE_BUILD" == "True" && "$PRE_RELEASE_SUFFIX_STRING" != "none" ]]; then
          if [[ "$PRE_RELEASE_SUFFIX_NUMBER" -eq 0 ]]; then
            echo "##vso[task.setvariable variable=ReleaseVersionSuffix;isOutput=true]-$PRE_RELEASE_SUFFIX_STRING"
          else
            echo "##vso[task.setvariable variable=ReleaseVersionSuffix;isOutput=true]-$PRE_RELEASE_SUFFIX_STRING.$PRE_RELEASE_SUFFIX_NUMBER"
          fi
        else
          echo "##vso[task.setvariable variable=ReleaseVersionSuffix;isOutput=true]"
        fi
    - script: |
        # Extracting hours and minutes
        date=$(date +'%Y%m%d')
        # Set the hhmm value as a pipeline variable
        echo "##vso[task.setvariable variable=BuildDate;isOutput=true]$date"
      displayName: 'Set Start Date as Variable'
      name: Set_Build_Date

    - script: |
        # Extracting hours and minutes
        hhmm=$(date +'%H%M')
        # Set the hhmm value as a pipeline variable
        echo "##vso[task.setvariable variable=BuildTime;isOutput=true]$hhmm"
      displayName: 'Set Start Time as Variable'
      name: Set_Build_Time
    - template: ../templates/component-governance-component-detection-steps.yml
      parameters:
        condition: 'succeeded'

- stage: Debug
  dependsOn: Setup
  jobs:
  - job: D1
    pool:
      name: 'onnxruntime-Ubuntu2204-AMD-CPU'
      os: linux
    variables:
      MyVar: $[stageDependencies.Setup.Set_Variables.outputs['Set_Release_Version_Suffix.ReleaseVersionSuffix']]
      BuildDate: $[stageDependencies.Setup.Set_Variables.outputs['Set_Build_Date.BuildDate']]
      BuildTime: $[stageDependencies.Setup.Set_Variables.outputs['Set_Build_Time.BuildTime']]
    steps:
    - checkout: none
    - bash: echo $(MyVar)
    - bash: echo $(BuildTime)
    - bash: echo $(BuildDate)
    - template: ../templates/component-governance-component-detection-steps.yml
      parameters:
        condition: 'succeeded'
