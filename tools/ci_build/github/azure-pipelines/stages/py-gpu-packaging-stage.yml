parameters:
- name: build_py_parameters
  displayName: >
    Extra parameters to pass to build.py. Don't put newlines in here.
  type: string
  default: ''

# TODO: Now the Windows jobs use a different cmake build type. Consider to merge it.
- name: cmake_build_type
  type: string
  displayName: 'Linux packages cmake build type. Linux Only.'
  default: 'Release'
  values:
   - Debug
   - Release
   - RelWithDebInfo
   - MinSizeRel

- name: cuda_version
  type: string
  displayName: 'CUDA version. Windows Only.'
  default: '12.8'
  values:
   - 12.8
   - 13.0

- name: cudnn_folder
  type: string
  default: '9.14.0.64_cuda13'

- name: PythonVersions
  type: object
  displayName: 'Python versions to build'
  default:
    - '3.11'
    - '3.12'
    - '3.13'
    - '3.14'

- name: cmake_cuda_archs
  type: string
  displayName: 'CMAKE_CUDA_ARCHITECTURES for Windows'

- name: docker_base_image
  type: string
  displayName: 'Linux docker base image'

stages:
    # Use separated cudnn folder for CUDA 13.0 on Windows.
    - ${{ if eq(parameters.cuda_version, '13.0') }}:
      - ${{ each python_version in parameters.PythonVersions }}:
        - template: py-win-gpu-stage.yml
          parameters:
            PYTHON_VERSION: ${{ python_version }}
            EP_NAME: gpu
            CudaVersion: ${{ parameters.cuda_version }}
            EP_BUILD_FLAGS: --enable_lto --use_cuda --cuda_home=$(Agent.TempDirectory)\v${{ parameters.cuda_version }} --cudnn_home=$(Agent.TempDirectory)\${{ parameters.cudnn_folder }} --cmake_extra_defines "CMAKE_CUDA_ARCHITECTURES=${{ parameters.cmake_cuda_archs }}"
            use_tensorrt: True

    - ${{ if eq(parameters.cuda_version, '12.8') }}:
      - ${{ each python_version in parameters.PythonVersions }}:
        - template: py-win-gpu-stage.yml
          parameters:
            PYTHON_VERSION: ${{ python_version }}
            EP_NAME: gpu
            CudaVersion: ${{ parameters.cuda_version }}
            EP_BUILD_FLAGS: --enable_lto --use_cuda --cuda_home=$(Agent.TempDirectory)\v${{ parameters.cuda_version }} --cmake_extra_defines "CMAKE_CUDA_ARCHITECTURES=${{ parameters.cmake_cuda_archs }}"
            use_tensorrt: True

    - template: py-linux-gpu-stage.yml
      parameters:
          arch: 'x86_64'
          machine_pool: 'onnxruntime-Ubuntu2404-AMD-CPU'
          extra_build_arg: ${{ parameters.build_py_parameters }}
          cmake_build_type: ${{ parameters.cmake_build_type }}
          cuda_version: ${{ parameters.cuda_version }}
          docker_base_image: ${{ parameters.docker_base_image }}
