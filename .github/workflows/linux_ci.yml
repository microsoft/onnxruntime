name: Linux CI

on:
  push:
    branches: [ main, 'rel-*', 'snnn/linux_ci']
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ["self-hosted", "1ES.Pool=onnxruntime-github-Ubuntu2204-AMD-CPU"]
    permissions:
      actions: read
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python 3.x
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
            
      - name: Build Docker Image
        uses: ./.github/actions/build-docker-image
        with:
          Dockerfile: ${{ github.workspace }}/tools/ci_build/github/linux/docker/inference/x86_64/default/cpu/Dockerfile
          Repository: 'onnxruntimecpubuildcentos8x64'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed for context

      - name: Create .onnx directory
        run: mkdir -p $HOME/.onnx

      - name: Build and Test ONNX Runtime in Docker
        env:          
          ALLOW_RELEASED_ONNX_OPSET_ONLY: 0
        run: |
          docker run --rm \
            --volume /data/onnx:/data/onnx:ro \
            --volume /data/models:/data/models:ro \
            --volume ${{ github.workspace }}:/onnxruntime_src \
            --volume $HOME/.onnx:/home/onnxruntimedev/.onnx \
            -w /onnxruntime_src \
            -e ALLOW_RELEASED_ONNX_OPSET_ONLY \
            -e NIGHTLY_BUILD=1 \
            onnxruntimecpubuildcentos8x64 \
            /bin/bash -c 'set -ex; \
              python3 tools/ci_build/build.py \
                --build_dir build --cmake_generator Ninja \
                --config Debug \
                --skip_submodule_sync \
                --build_shared_lib \
                --parallel \
                --use_vcpkg --use_vcpkg_ms_internal_asset_cache \
                --enable_onnx_tests \
                --enable_address_sanitizer \
                --update --build;
              python3 /onnxruntime_src/tools/ci_build/build.py \
                --build_dir build --cmake_generator Ninja \
                --config Debug \
                --skip_submodule_sync \
                --build_shared_lib \
                --parallel \
                --use_vcpkg --use_vcpkg_ms_internal_asset_cache \
                --enable_onnx_tests \
                --enable_address_sanitizer \
                --test;'