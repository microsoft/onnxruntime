name: Linux CI

on:
  push:
    branches: [ main, 'rel-*', 'snnn/linux_ci']
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ["self-hosted", "1ES.Pool=onnxruntime-github-Ubuntu2204-AMD-CPU"]
    permissions:
      actions: read
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python 3.x
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
            
      - name: Build Docker Image
        uses: ./.github/actions/build-docker-image
        with:
          Dockerfile: ${{ github.workspace }}/tools/ci_build/github/linux/docker/inference/x86_64/default/cpu/Dockerfile
          DockerBuildArgs: "--build-arg BUILD_UID=$( id -u )"
          Repository: 'onnxruntimecpubuildcentos8x64'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed for context