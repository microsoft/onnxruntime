# Copyright (c) Qualcomm Technologies, Inc. and/or its subsidiaries.
# SPDX-License-Identifier: MIT

name: Publish ONNX Runtime Execution Provider wheel

on:
  workflow_call:
    inputs:
      nightly_build:
        description: "If true, include a verbose version string in wheel file names."
        type: boolean
        default: true
      skip_publish:
        type: boolean
        default: false
  workflow_dispatch:
    inputs:
      nightly_build:
        description: "If true, include a verbose version string in wheel file names."
        type: boolean
        default: true
      skip_publish:
        description: "If true, do everything except publishing to the PyPI server"
        type: boolean
        default: true

jobs:
  build-wheels:
    uses: ./.github/workflows/qualcomm-internal-build-wheels.yml
    secrets: inherit
    with:
      nightly_build: ${{inputs.nightly_build}}

  publish-wheel-workflow:
    name: "Publish distribution to PyPI"
    runs-on: [Linux, self-hosted, Build]
    needs: [build-wheels]
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4.1.1

      # We only publish this for AI Hub to use and they only want x86_64 Linux
      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: ORT linux x86_64 Python 3.10 Wheel
          path: ${{ github.workspace }}/build/dist

      - name: Create config file
        run: |
          echo "[distutils]" > build/pypirc
          echo "index-servers = local" >> build/pypirc
          echo "[local]" >> build/pypirc
          echo "repository: http://ort-ep-win-01.na.qualcomm.com:8080" >> build/pypirc
          echo "username = OrtQnnEpUploader" >> build/pypirc
          echo "password = ${{ secrets.UPLOADER_PASSWORD }}" >> build/pypirc

      - name: Install Dependencies
        run: |
          python3 -m venv venv
          source venv/bin/activate && pip3 install twine

      - name: Check wheel
        run: |
          source venv/bin/activate && twine check ${{ github.workspace }}/build/dist/*

      - name: Publish
        if: ${{ !inputs.skip_publish }}
        run: |
          source venv/bin/activate && twine upload --config-file=build/pypirc -r local ${{ github.workspace }}/build/dist/*
