name: Qualcomm_Internal_Windows_CI
on:
  push:
    branches:
      - main
      - rel-*
  pull_request:
    branches:
      - main

jobs:
  Windows-CUDA-12:
    runs-on: ["self-hosted", "Windows", "X64"]
    steps:
      - name: Clean Up
        shell: cmd
        run: |
          echo ${{ github.workspace }}
          if exist onnxruntime-qnn-ep (rmdir /S /Q onnxruntime-qnn-ep)
          if exist onnxruntime (rmdir /S /Q onnxruntime)

        working-directory: ${{ github.workspace }}

      - name: Fetch Code
        shell: cmd
        run: |
          git clone --depth=1 --recursive https://github.com/microsoft/onnxruntime
          cd onnxruntime
          git remote add mlg-github git@github.qualcomm.com:MLG/onnxruntime-qnn-ep.git
          git fetch mlg-github
          git checkout ${{ github.head_ref }}

        working-directory: ${{ github.workspace }}

      - name: Qualcomm Internal Build Script
        shell: cmd
        run: |
          "C:\Program Files\Microsoft Visual Studio\2022\Professional\VC\Auxiliary\Build\vcvarsall.bat" amd64 && ^
          .\build.bat --config RelWithDebInfo --build_shared_lib --parallel --compile_no_warning_as_error --cmake_generator "Visual Studio 17 2022" ^
          --use_qnn --qnn_home "C:\Users\hungjuiw\workspace\qairt\2.31.0.250130"

        working-directory: ${{ github.workspace }}\onnxruntime

      # The build machine doesn't have a GPU. So the value of CMAKE_CUDA_ARCHITECTURES doesn't matter.
      # - name: Build code
      #   run: python tools\ci_build\build.py --windows_sdk_version 10.0.22621.0 --enable_training --build_java --config Debug --build_dir D:\b --skip_submodule_sync --build_csharp --update --build --parallel --cmake_generator "Visual Studio 17 2022" --build_shared_lib --enable_pybind --use_cuda --cuda_home=${{ github.workspace }}\cuda_sdk\v12.2 --enable_cuda_profiling  --cmake_extra_defines CMAKE_CUDA_ARCHITECTURES=75

# - uses: actions/checkout@v4
#   with:
#     fetch-depth: 0
#     submodules: recursive

# - uses: actions/setup-python@v5
#   with:
#     python-version: '3.8.x'
#     architecture: 'x64'

# - name: Update
#   shell: cmd
#   run: |
#     git submodule sync ^
#     git submodule update --init --recursive

# - name: Delete build folder
#   shell: cmd
#   run: |
#     echo Hello

# concurrency:
#   group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
#   cancel-in-progress: true

# env:
#   AZCOPY_AUTO_LOGIN_TYPE: MSI
#   AZCOPY_MSI_CLIENT_ID: 63b63039-6328-442f-954b-5a64d124e5b4

# - uses: actions/setup-node@v4
#   with:
#     node-version: 18

# - name: Download cuda
#   run: azcopy.exe cp --recursive "https://lotusscus.blob.core.windows.net/models/cuda_sdk/v12.2" cuda_sdk

# .\build.bat --config RelWithDebInfo --build_shared_lib --parallel --compile_no_warning_as_error --cmake_generator "Visual Studio 17 2022"