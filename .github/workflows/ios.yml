name: iOS_CI_on_Mac

on:
  push:
    branches:
      - main
      - rel-*
  pull_request:
    branches:
      - main
      - rel-*
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request' && github.ref || github.sha }}
  cancel-in-progress: true

jobs:
  iOS_CI_on_Mac:
    runs-on: macos-14
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: false
      - uses: microsoft/onnxruntime-github-actions/setup-build-tools@v0.0.9
        with:
          vcpkg-version: '2025.08.27'
          vcpkg-hash: 9a4b32849792e13bee1d24726f073b3881acae4165206ddf1a6378e44a4ddd05b3ee93f55ff46d8e8873b3cbcd06606212989e248f0bd615a5bf365070074079
          cmake-version: '3.31.8'
          cmake-hash: 99cc9c63ae49f21253efb5921de2ba84ce136018abf08632c92c060ba91d552e0f6acc214e9ba8123dee0cf6d1cf089ca389e321879fd9d719a60d975bcffcc8
          add-cmake-to-path: 'true'
          disable-terrapin: 'true'
      - name: Use Xcode ${{ env.XCODE_VERSION }}
        shell: bash
        run: |
          set -e -x
          XCODE_DEVELOPER_DIR="/Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer"
          sudo xcode-select --switch "${XCODE_DEVELOPER_DIR}"

      - name: (CPU, CoreML, XNNPACK EPs) Build onnxruntime for iOS x86_64 and run tests using simulator
        shell: bash
        run: |
          python3 ${{ github.workspace }}/tools/ci_build/build.py \
            --skip_submodule_sync \
            --build_dir ${{ github.workspace }}/iOS \
            --build_shared_lib \
            --use_coreml \
            --use_xnnpack \
            --ios \
            --apple_sysroot iphonesimulator \
            --osx_arch x86_64 \
            --apple_deploy_target=15.1 \
            --use_xcode \
            --config RelWithDebInfo \
            --build_apple_framework \
            --parallel \
            --use_binskim_compliant_compile_flags
        env:
          ORT_GET_SIMULATOR_DEVICE_INFO_REQUESTED_RUNTIME_VERSION: ${{ env.IOS_SIMULATOR_RUNTIME_VERSION }}

    timeout-minutes: 150
    env:
      XCODE_VERSION: 15.3.0
      IOS_SIMULATOR_RUNTIME_VERSION: 17.4
