# common k8s cluster configurations
.default_settings:
  rules:
      - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
        when: always
      - when: manual
  tags:
    - ealta-prod
  variables:
    KUBERNETES_CPU_REQUEST: "8"
    KUBERNETES_CPU_LIMIT: "10"
    KUBERNETES_NODE_SELECTOR_ARCH: 'kubernetes.io/arch=amd64'
    KUBERNETES_NODE_SELECTOR_TYPE: 'karpenter.sh/capacity-type=spot'
    FF_DISABLE_UMASK_FOR_DOCKER_EXECUTOR: true
    GIT_SUBMODULE_STRATEGY: recursive

.default_settings_build:
  variables:
    KUBERNETES_MEMORY_REQUEST: "24Gi"
    KUBERNETES_MEMORY_LIMIT: "28Gi"

.default_settings_test:
  variables:
    KUBERNETES_MEMORY_REQUEST: "8Gi"
    KUBERNETES_MEMORY_LIMIT: "12Gi"


# change directory to the cloned git dir so we can mark it as a safe dir for submodule cloning
.common_setup:
  before_script:
    - git config --global --add safe.directory "$CI_PROJECT_DIR"
    - |
      git submodule foreach --recursive \
      'git config --global --add safe.directory "$toplevel/$path"'

# newer versions of the onnxrt need python > 3.9
# override the system default with newer python installed via homebrew
# cmake binary is also included via homebrew path
.mac_common:
  variables:
    GIT_TEMPLATE_DIR: "$CI_PROJECT_DIR/.git-template-$CI_JOB_ID"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: always
    - when: manual
  before_script:
    - export PATH="/opt/homebrew/bin:$PATH"
    - /opt/homebrew/opt/python@3.12/bin/python3.12 -m venv .venv
    - source .venv/bin/activate
