<Project Sdk="MSBuild.Sdk.Extras/3.0.22">
  <PropertyGroup>
    <!--- packaging properties -->
    <OrtPackageId Condition="'$(OrtPackageId)' == ''">Microsoft.ML.OnnxRuntime</OrtPackageId>
  </PropertyGroup>

  <!-- only include the Xamarin mobile targets if we're building an ORT package, 
       and only if the mobile workloads are installed -->
  <Choose>
    <When Condition="('$(OrtPackageId)' == 'Microsoft.ML.OnnxRuntime' OR '$(OrtPackageId)' == 'Microsoft.ML.OnnxRuntime.Gpu') AND Exists('$(MSBuildExtensionsPath)\Xamarin\Android') AND Exists('$(MSBuildExtensionsPath)\Xamarin\iOS')">
      <PropertyGroup>
        <TargetFrameworks>netstandard1.1;netstandard2.0;xamarinios10;monoandroid11.0;net5.0;netcoreapp3.1</TargetFrameworks>
      </PropertyGroup>      
    </When>
    <Otherwise>
      <PropertyGroup>
        <TargetFrameworks>netstandard1.1;netstandard2.0;net5.0;netcoreapp3.1</TargetFrameworks>
      </PropertyGroup>    
   </Otherwise>
  </Choose>
  
  <PropertyGroup>
    <Platforms>AnyCPU;x86</Platforms>
    <LangVersion>7.2</LangVersion>
    <AllowUnsafeBlocks>true</AllowUnsafeBlocks>
    <SignAssembly>true</SignAssembly>
    <AssemblyOriginatorKeyFile>..\..\OnnxRuntime.snk</AssemblyOriginatorKeyFile>

    <!--internal build related properties-->
    <OnnxRuntimeRoot>$(ProjectDir)..\..\..</OnnxRuntimeRoot>
    <OnnxRuntimeCsharpRoot>$(OnnxRuntimeRoot)\csharp</OnnxRuntimeCsharpRoot>
    <TargetArchitecture Condition=" '$(TargetArchitecture)' == '' ">x64</TargetArchitecture>  

    <RootNamespace>Microsoft.ML.OnnxRuntime</RootNamespace>
    <AssemblyName>Microsoft.ML.OnnxRuntime</AssemblyName>
    <EnableDefaultItems>false</EnableDefaultItems>
    <EnableDefaultCompileItems>false</EnableDefaultCompileItems>
    <DebugType>portable</DebugType>

    <!--- The package name is always hardcoded as the package created by this project only contains managed assemblies -->
    <!--- The parameter OrtPackageId is only used for some conditional logic below -->    
    <PackageId>Microsoft.ML.OnnxRuntime.Managed</PackageId>
    <Authors>Microsoft</Authors>
    <PackageVersion Condition=" '$(PackageVersion)' == '' And '$(Configuration)' == 'Debug' ">1.0.0</PackageVersion>
    <PackageVersion Condition=" '$(PackageVersion)' == '' ">0.0.0</PackageVersion>
    <Version>$(PackageVersion)</Version>
    <Description>This package contains ONNX Runtime for .Net platforms</Description>
    <PackageTags>ONNX;ONNX Runtime;Machine Learning</PackageTags>
    <PackageProjectUrl>https://github.com/Microsoft/onnxruntime</PackageProjectUrl>
    <Copyright>Â© Microsoft Corporation. All rights reserved.</Copyright>
    <PackageLicenseFile>LICENSE.txt</PackageLicenseFile>
    <PackageIcon>ORT_icon_for_light_bg.png</PackageIcon>
    <PackageReleaseNotes>
      Release Def:
        Branch: $(BUILD_SOURCEBRANCH)
        Commit: $(BUILD_SOURCEVERSION)
        Build: https://aiinfra.visualstudio.com/Lotus/_build/results?buildId=$(BUILD_BUILDID)
    </PackageReleaseNotes>
    <!-- sourcelink flags -->
    <PublishRepositoryUrl>true</PublishRepositoryUrl>

    <!-- Optional: Embed source files that are not tracked by the source control manager in the PDB -->
    <!--EmbedUntrackedSources>true</EmbedUntrackedSources-->

    <GenerateTargetFrameworkAttribute>false</GenerateTargetFrameworkAttribute>
    <GenerateAssemblyInfo>false</GenerateAssemblyInfo>
    <AllowedOutputExtensionsInPackageBuildOutputFolder>$(AllowedOutputExtensionsInPackageBuildOutputFolder);.pdb</AllowedOutputExtensionsInPackageBuildOutputFolder>
    <Configurations>Debug;Release;RelWithDebInfo</Configurations>

    <IsLinuxBuild Condition="'$([System.Runtime.InteropServices.RuntimeInformation]::IsOSPlatform($([System.Runtime.InteropServices.OSPlatform]::Linux)))' == 'true'">true</IsLinuxBuild> 
    <IsWindowsBuild Condition="'$([System.Runtime.InteropServices.RuntimeInformation]::IsOSPlatform($([System.Runtime.InteropServices.OSPlatform]::Windows)))' == 'true'">true</IsWindowsBuild> 
    <IsMacOSBuild Condition="'$([System.Runtime.InteropServices.RuntimeInformation]::IsOSPlatform($([System.Runtime.InteropServices.OSPlatform]::OSX)))' == 'true'">true</IsMacOSBuild>
  </PropertyGroup>

    <PropertyGroup Condition="'$(IsLinuxBuild)'=='true'">
        <!--internal build related properties for Linux -->
        <OnnxRuntimeBuildDirectory Condition="'$(OnnxRuntimeBuildDirectory)'==''">$(OnnxRuntimeCsharpRoot)\..\build\Linux</OnnxRuntimeBuildDirectory>
        <NativeBuildOutputDir>$(OnnxRuntimeBuildDirectory)\$(Configuration)</NativeBuildOutputDir>
    </PropertyGroup>

    <PropertyGroup Condition="'$(IsWindowsBuild)'=='true'">
        <!--internal build related properties for Windows -->
        <OnnxRuntimeBuildDirectory Condition="'$(OnnxRuntimeBuildDirectory)'==''">$(OnnxRuntimeCsharpRoot)\..\build\Windows</OnnxRuntimeBuildDirectory>
        <NativeBuildOutputDir>$(OnnxRuntimeBuildDirectory)\$(Configuration)\$(Configuration)</NativeBuildOutputDir>
    </PropertyGroup>

    <PropertyGroup Condition="'$(IsMacOSBuild)'=='true'">
        <!--internal build related properties for OSX -->
        <OnnxRuntimeBuildDirectory Condition="'$(OnnxRuntimeBuildDirectory)'==''">$(OnnxRuntimeCsharpRoot)\..\build\MacOS</OnnxRuntimeBuildDirectory>
        <NativeBuildOutputDir>$(OnnxRuntimeBuildDirectory)\$(Configuration)</NativeBuildOutputDir>
    </PropertyGroup>

    <PropertyGroup Condition="$(TargetFramework.StartsWith('xamarinios'))">
      <DefineConstants>__IOS__;__MOBILE__;</DefineConstants>
    </PropertyGroup>

    <PropertyGroup Condition="$(TargetFramework.StartsWith('monoandroid'))">
      <DefineConstants>__ANDROID__;__MOBILE__;</DefineConstants>
    </PropertyGroup>

    <PropertyGroup Condition=" $(TargetFramework.StartsWith('net')) AND !$(TargetFramework.StartsWith('netstandard')) ">
      <DefineConstants>__NETCOREAPP_NETFRAMEWORK__;</DefineConstants>
    </PropertyGroup>

  <ItemGroup>
    <None Include="$(OnnxRuntimeCsharpRoot)\..\include\onnxruntime\core\session\onnxruntime_*.h"
          PackagePath="\build\native\include"
          Pack="false"
          CopyToOutputDirectory="Never"
          Visible="false"
    />
    <None Include="$(OnnxRuntimeCsharpRoot)\..\include\onnxruntime\core\providers\cpu\cpu_provider_factory.h"
          PackagePath="\build\native\include"
          Pack="false"
          CopyToOutputDirectory="Never"
          Visible="false"
    />
    <None Include="$(OnnxRuntimeCsharpRoot)\..\include\onnxruntime\core\providers\dml\dml_provider_factory.h"
          Condition="'$(OrtPackageId)' == 'Microsoft.ML.OnnxRuntime.DirectML'"
          PackagePath="\build\native\include"
          Pack="false"
          CopyToOutputDirectory="Never"
          Visible="false"
    />
    <None Include="$(NativeBuildOutputDir)\libonnxruntime.so"
          Condition="Exists('$(NativeBuildOutputDir)\libonnxruntime.so')"
          PackagePath="\runtimes\linux-$(TargetArchitecture)\native"
          Pack="false"
          CopyToOutputDirectory="Never"
          Visible="false"
    />
    <None Include="$(NativeBuildOutputDir)\onnxruntime.lib"
          Condition="Exists('$(NativeBuildOutputDir)\onnxruntime.lib')"
          PackagePath="\runtimes\win-$(TargetArchitecture)\native"
          Pack="false"
          CopyToOutputDirectory="Never"
          Visible="false"
    />
    <None Include="$(NativeBuildOutputDir)\onnxruntime.dll"
          Condition="Exists('$(NativeBuildOutputDir)\onnxruntime.dll')"
          PackagePath="\runtimes\win-$(TargetArchitecture)\native"
          Pack="false"
          CopyToOutputDirectory="PreserveNewest"
          Visible="false"
    />
    <None Include="$(NativeBuildOutputDir)\onnxruntime.pdb"
          Condition="Exists('$(NativeBuildOutputDir)\onnxruntime.pdb')"
          PackagePath="\runtimes\win-$(TargetArchitecture)\native"
          Pack="false"
          CopyToOutputDirectory="PreserveNewest"
          Visible="false"
    />
    <None Include="$(NativeBuildOutputDir)\dnnl.dll"
          Condition="Exists('$(NativeBuildOutputDir)\dnnl.dll')"
          PackagePath="\runtimes\win-$(TargetArchitecture)\native"
          Pack="false"
          CopyToOutputDirectory="PreserveNewest"
          Visible="false"
    />
    <None Include="$(NativeBuildOutputDir)\mklml.dll"
          Condition="Exists('$(NativeBuildOutputDir)\mklml.dll')"
          PackagePath="\runtimes\win-$(TargetArchitecture)\native"
          Pack="false"
          CopyToOutputDirectory="PreserveNewest"
          Visible="false"
    />
    <None Include="$(NativeBuildOutputDir)\libiomp5md.dll"
          Condition="Exists('$(NativeBuildOutputDir)\libiomp5md.dll')"
          PackagePath="\runtimes\win-$(TargetArchitecture)\native"
          Pack="false"
          CopyToOutputDirectory="PreserveNewest"
          Visible="false"
    />
    <None Include="$(NativeBuildOutputDir)\tvm.dll"
          Condition="Exists('$(NativeBuildOutputDir)\tvm.dll')"
          PackagePath="\runtimes\win-$(TargetArchitecture)\native"
          Pack="false"
          CopyToOutputDirectory="PreserveNewest"
          Visible="false"
    />
    <None Include="$(OnnxRuntimeCsharpRoot)\..\LICENSE.txt;$(OnnxRuntimeCsharpRoot)\..\ThirdPartyNotices.txt;$(OnnxRuntimeCsharpRoot)\..\ORT_icon_for_light_bg.png;$(OnnxRuntimeCsharpRoot)\..\docs\Privacy.md"
          PackagePath="\"
          Pack="true"
          Visible="false"
    />
    <None Include="targets\netstandard\$(PackageId).targets"
          PackagePath="build\netstandard1.1\$(PackageId).targets;build\netstandard2.0\$(PackageId).targets"
          Pack="true"
          Visible="false" 
    />

    <!-- Some tools to be packaged in nightly build only, should not be released -->
    <!-- These are copied to the runtimes folder for convenience of loading with the dlls -->
    <None Include="$(NativeBuildOutputDir)\onnxruntime_perf_test.exe"
          Condition="('$(IsReleaseBuild)' != 'true') And ($(TargetArchitecture)=='x64') And Exists('$(NativeBuildOutputDir)\onnxruntime_perf_test.exe')"
          PackagePath="\runtimes\win-$(TargetArchitecture)\native"
          Pack="false"
          Visible="false"
    />
    <None Include="$(NativeBuildOutputDir)\onnx_test_runner.exe"
          Condition="('$(IsReleaseBuild)' != 'true') And ($(TargetArchitecture)=='x64') And Exists('$(NativeBuildOutputDir)\onnx_test_runner.exe')"
          PackagePath="\runtimes\win-$(TargetArchitecture)\native"
          Pack="false"
          Visible="false"
    />
  </ItemGroup>

  <ItemGroup>
    <Compile Include="**\*.shared.cs" Link="%(Filename)%(Extension)" />
  </ItemGroup>

  <ItemGroup Condition="$(TargetFramework.StartsWith('netstandard'))">
    <PackageReference Include="System.Memory" Version="4.5.3" />
    <PackageReference Include="Microsoft.SourceLink.GitHub" Version="1.0.0" PrivateAssets="All" />
    <Compile Include="**\*.netstandard.cs" Link="platform\netstandard\%(Filename)%(Extension)" />
  </ItemGroup>

  <ItemGroup Condition=" $(TargetFramework.StartsWith('net')) AND !$(TargetFramework.StartsWith('netstandard')) ">
    <PackageReference Include="System.Memory" Version="4.5.3" />
    <PackageReference Include="Microsoft.SourceLink.GitHub" Version="1.0.0" PrivateAssets="All" />
    <Compile Include="**\*.net.cs" Link="platform\net\%(Filename)%(Extension)" />
  </ItemGroup>

  <ItemGroup Condition="$(TargetFramework.StartsWith('monoandroid'))">
    <Compile Include="**\*.android.cs" Link="platform\android\%(Filename)%(Extension)" />
  </ItemGroup>

  <ItemGroup Condition="$(TargetFramework.StartsWith('xamarinios')) ">
    <Compile Include="**\*.ios.cs" Link="platform\ios\%(Filename)%(Extension)" />
  </ItemGroup>

  <ItemGroup>
    <LicenseFile Include="$(OnnxRuntimeCsharpRoot)\..\LICENSE" Visible="false" />
    <TargetsFile Include="$(OnnxRuntimeCsharpRoot)\src\Microsoft.ML.OnnxRuntime\targets\netstandard\targets.xml" Visible="false" />
  </ItemGroup>

  <Target Name="CopyMiscFiles" BeforeTargets="PreBuildEvent">
    <Copy SourceFiles="@(LicenseFile)" DestinationFiles="@(LicenseFile->'$(OnnxRuntimeCsharpRoot)\..\%(Filename).txt')" />
    <Copy SourceFiles="@(TargetsFile)" DestinationFiles="@(TargetsFile->'$(OnnxRuntimeCsharpRoot)\src\Microsoft.ML.OnnxRuntime\targets\netstandard\$(PackageId).targets')" />
  </Target>

  <Target Name="CopyPackage" AfterTargets="Pack">
    <Copy
      SourceFiles="$(OutputPath)\$(PackageId).$(PackageVersion).nupkg"
      DestinationFolder="$(NativeBuildOutputDir)"
    />
  </Target>
  
</Project>